#!/usr/bin/env bash

# Dynamically create the packer-virt-packer-sysprep control script using the
# settings in the Packer configuration template.
#
# The control script is executed by the packer-virt-packer-sysprep.service unit
# file and provides the mechanism through which all other requested
# virt-packer-sysprep style scripts are executed.
#
# By default all virt-packer-sysprep style operations will be run unless
# explicitly disabled in the Packer configuration template. This is
# achieved by setting the environment variable that corresponds to the
# operation to something other than 'true'.

set -o errexit

# The directory that is to be used to hold all packer-virt-packer-sysprep files
# and operations scripts is specified in the Packer configuration template
# and exported as an environment variable
export prefix="/packer-virt-sysprep"

# All virt-packer-sysprep style operations will run by default unless explicitly
# disabled in the Packer template
: "${SYSPREP_OP_BASH_HISTORY:=true}"
: "${SYSPREP_OP_CLOUD_INIT:=true}"
: "${SYSPREP_OP_CRASH_DATA:=true}"
: "${SYSPREP_OP_DHCP_CLIENT_STATE:=true}"
: "${SYSPREP_OP_FIREWALL_RULES:=true}"
: "${SYSPREP_OP_LOGFILES:=true}"
: "${SYSPREP_OP_MACHINE_ID:=true}"
: "${SYSPREP_OP_MAIL_SPOOL:=true}"
: "${SYSPREP_OP_PACKAGE_MANAGER_CACHE:=true}"
: "${SYSPREP_OP_RPM_DB:=true}"
: "${SYSPREP_OP_SSH_HOSTKEYS:=true}"
: "${SYSPREP_OP_TMP_FILES:=true}"
: "${SYSPREP_OP_YUM_UUID:=true}"

# bash_history: Remove all users bash history. Remove:
#     * /home/*/.bash_history
#     * /root/.bash_history
if [ "${SYSPREP_OP_BASH_HISTORY}" = true ]; then
    echo "Running ${prefix}/sysprep-op-bash-history.sh"
    "${prefix}/sysprep-op-bash-history.sh"
fi

# cloud-init: Reinitialise cloud-init by removing run-time data and logs:
#     * /var/lib/cloud-init/*
#     * /var/log/cloud-init.log
if [ "${SYSPREP_OP_CLOUD_INIT}" = true ]; then
    echo "Running ${prefix}/sysprep-op-cloud-init.sh"
    "${prefix}/sysprep-op-cloud-init.sh"
fi

# crash_data: Remove crash data generated by kexec-tools by removing:
#     * /var/crash/*
#     * /var/log/dump/*
if [ "${SYSPREP_OP_CRASH_DATA}" = true ]; then
    echo "Running ${prefix}/sysprep-op-crash-data.sh"
    "${prefix}/sysprep-op-crash-data.sh"
fi

# dhcp-client-state: Remove DHCP client release by removing:
#     * /var/lib/dhclient/*
#     * /var/lib/dhcp/*
if [ "${SYSPREP_OP_DHCP_CLIENT_STATE}" = true ]; then
    echo "Running ${prefix}/sysprep-op-dhcp-client-state.sh"
    "${prefix}/sysprep-op-dhcp-client-state.sh"
fi

# firewall-rules: Remove custom firewall rules by removing:
#     * /etc/sysconfig/iptables
#     * /etc/firewalld/services/*
#     * /etc/firewalld/zones/*
if [ "${SYSPREP_OP_FIREWALL_RULES}" = true ]; then
    echo "Running ${prefix}/sysprep-op-firewall-rules.sh"
    "${prefix}/sysprep-op-firewall-rules.sh"
fi

# logfiles: Remove every logfile ever created by removing:
#     # ...a ton of stuff!
if [ "${SYSPREP_OP_LOGFILES}" = true ]; then
    echo "Running ${prefix}/sysprep-op-logfiles.sh"
    "${prefix}/sysprep-op-logfiles.sh"
fi

# machine-id: Remove the local machine ID by removing content from:
#     * /etc/machine-id
#     * /var/lib/dbus/machine-id
if [ "${SYSPREP_OP_MACHINE_ID}" = true ]; then
    echo "Running ${prefix}/sysprep-op-machine-id.sh"
    "${prefix}/sysprep-op-machine-id.sh"
fi

# mail-spool: Remove email from the local mail spool directory
#     # /var/spool/mail/*
#     * /var/mail/*
if [ "${SYSPREP_OP_MAIL_SPOOL}" = true ]; then
    echo "Running ${prefix}/sysprep-op-mail-spool.sh"
    "${prefix}/sysprep-op-mail-spool.sh"
fi

# package-manager-cache: Remove package manager cache by removing files
# under:
#     * /var/cache/apt/archives/
#     * /var/cache/dnf/
#     * /var/cache/yum/
#     * /var/cache/zypp*
if [ "${SYSPREP_OP_PACKAGE_MANAGER_CACHE}" = true ]; then
    echo "Running ${prefix}/sysprep-op-package-manager-cache.sh"
    "${prefix}/sysprep-op-package-manager-cache.sh"
fi

# rpm-db: Remove host-specific RPM database files by removing:
#     # /var/lib/rpm/__db.*
if [ "${SYSPREP_OP_RPM_DB}" = true ]; then
    echo "Running ${prefix}/sysprep-op-rpm-db.sh"
    "${prefix}/sysprep-op-rpm-db.sh"
fi

# ssh-hostkeys: Remove the SSH host keys in the guest by removing:
#     * /etc/ssh/*_host_*
if [ "${SYSPREP_OP_SSH_HOSTKEYS}" = true ]; then
    echo "Running ${prefix}/sysprep-op-ssh-hostkeys.sh"
    "${prefix}/sysprep-op-ssh-hostkeys.sh"
fi

# tmp-files: Remove all temporary files and directories by removing:
#     * /tmp/*
#     * /var/tmp/*
if [ "${SYSPREP_OP_TMP_FILES}" = true ]; then
    echo "Running ${prefix}/sysprep-op-tmp-files.sh"
    "${prefix}/sysprep-op-tmp-files.sh"
fi

# yum-uuid: Remove the yum UUID
#     * /var/lib/yum/uuid
if [ "${SYSPREP_OP_YUM_UUID}" = true ]; then
    echo "Running ${prefix}/sysprep-op-yum-uuid.sh"
    "${prefix}/sysprep-op-yum-uuid.sh"
fi
